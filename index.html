<!DOCTYPE html>
<html lang="he">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>מעקב בריאות יומי</title>
    <link rel="manifest" href="manifest.json">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <meta name="apple-mobile-web-app-title" content="מעקב בריאות">
    <link rel="apple-touch-icon" href="images/icons/icon-192x192.png">
    <style>
        body {
            font-family: Arial, sans-serif;
            direction: rtl;
            text-align: right;
            margin: 0;
            padding: 20px;
            background-color: #f4f4f4;
            color: #333;
        }
        .container {
            background-color: #fff;
            padding: 20px;
            border-radius: 8px;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
            max-width: 500px;
            margin: 20px auto;
        }
        h1, h2 {
            color: #0056b3;
            text-align: center;
        }
        form div {
            margin-bottom: 15px;
        }
        label {
            display: block;
            margin-bottom: 5px;
            font-weight: bold;
        }
        input[type="text"],
        input[type="number"],
        input[type="time"],
        select,
        textarea {
            width: calc(100% - 22px); /* Adjusting for padding and border */
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 4px;
            box-sizing: border-box; /* Include padding and border in the element's total width and height */
        }
        button {
            background-color: #007bff;
            color: white;
            padding: 12px 20px;
            border: none;
            border-radius: 4px;
            cursor: pointer;
            font-size: 16px;
            width: 100%;
            box-sizing: border-box;
        }
        button:hover {
            background-color: #0056b3;
        }
        .message {
            margin-top: 20px;
            padding: 10px;
            border-radius: 4px;
            text-align: center;
        }
        .message.success {
            background-color: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        .message.error {
            background-color: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        #medicationForm {
            margin-top: 20px;
            border-top: 1px solid #eee;
            padding-top: 20px;
        }
        .medication-entry {
            border: 1px solid #ddd;
            padding: 15px;
            margin-bottom: 10px;
            border-radius: 5px;
            background-color: #f9f9f9;
        }
        .medication-entry button {
            width: auto;
            margin-top: 10px;
            background-color: #dc3545;
        }
        .medication-entry button:hover {
            background-color: #c82333;
        }
        #addMedicationBtn {
            background-color: #28a745;
            margin-top: 15px;
        }
        #addMedicationBtn:hover {
            background-color: #218838;
        }
    </style>
</head>
<body>
    <div class="container">
        <h1>מעקב בריאות יומי</h1>

        <h2>רישום ארוחה</h2>
        <form id="nutritionForm">
            <div>
                <label for="mealType">סוג ארוחה:</label>
                <select id="mealType" required>
                    <option value="">בחר סוג ארוחה</option>
                    <option value="ארוחת בוקר">ארוחת בוקר</option>
                    <option value="ארוחת צהריים">ארוחת צהריים</option>
                    <option value="ארוחת ערב">ארוחת ערב</option>
                    <option value="ארוחת ביניים">ארוחת ביניים</option>
                    <option value="חטיף">חטיף</option>
                    <option value="שתיה">שתיה</option>
                </select>
            </div>
            <div>
                <label for="mealDescription">תיאור הארוחה:</label>
                <textarea id="mealDescription" rows="3" required></textarea>
            </div>
            <button type="submit">רשום ארוחה</button>
            <div id="nutritionMessage" class="message" style="display:none;"></div>
        </form>

        <hr>

        <h2>רישום תרופות</h2>
        <form id="medicationForm">
            <div id="medicationsContainer">
                </div>
            <button type="button" id="addMedicationBtn">הוסף תרופה</button>
            <button type="submit">רשום תרופות</button>
            <div id="medicationMessage" class="message" style="display:none;"></div>
        </form>
    </div>

    <script>
        // זהו ה-URL המלא והמדויק של פריסת ה-Web App שלך ב-Google Apps Script.
        // הוא יחבר את האפליקציה ב-GitHub Pages לסקריפט שלך.
        const SCRIPT_URL = 'https://script.google.com/macros/s/AKfycbzuH8mGMKmACUftZTaGWbm0ipIRNVYCPwH_CVFaZsE8gOJVP_PJ_fW22-ZMAdksQ1UL/exec'; 

        // Function to get current date and time in Israel's timezone
        function getCurrentDateTime() {
            const now = new Date();
            const options = {
                year: 'numeric',
                month: '2-digit',
                day: '2-digit',
                hour: '2-digit',
                minute: '2-digit',
                second: '2-digit',
                hour12: false,
                timeZone: 'Asia/Jerusalem' // Israel's timezone
            };
            const formatter = new Intl.DateTimeFormat('he-IL', options);
            const parts = formatter.formatToParts(now);

            let date = '';
            let time = '';

            // Extract parts manually to ensure correct order (DD/MM/YYYY and HH:MM:SS)
            const day = parts.find(p => p.type === 'day').value;
            const month = parts.find(p => p.type === 'month').value;
            const year = parts.find(p => p.type === 'year').value;
            const hour = parts.find(p => p.type === 'hour').value;
            const minute = parts.find(p => p.type === 'minute').value;
            const second = parts.find(p => p.type === 'second').value;

            date = `${day}/${month}/${year}`;
            time = `${hour}:${minute}:${second}`;

            return { date, time };
        }

        // Helper function to display messages
        function displayMessage(elementId, message, type) {
            const messageElement = document.getElementById(elementId);
            messageElement.textContent = message;
            messageElement.className = `message ${type}`;
            messageElement.style.display = 'block';
            setTimeout(() => {
                messageElement.style.display = 'none';
            }, 5000); // Hide after 5 seconds
        }

        // --- Nutrition Form Handling ---
        document.getElementById('nutritionForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const { date, time } = getCurrentDateTime();
            const mealType = document.getElementById('mealType').value;
            const mealDescription = document.getElementById('mealDescription').value;

            const data = {
                type: 'nutrition',
                date: date,
                time: time,
                data: {
                    mealType: mealType,
                    mealDescription: mealDescription
                }
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors', // Required for Google Apps Script Web App
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                // Since 'no-cors' is used, we can't inspect the response directly.
                // Assume success if no network error.
                displayMessage('nutritionMessage', 'הארוחה נרשמה בהצלחה!', 'success');
                this.reset(); // Clear the form
            } catch (error) {
                console.error('Error:', error);
                displayMessage('nutritionMessage', 'שגיאה ברישום הארוחה. נסה שוב.', 'error');
            }
        });

        // --- Medication Form Handling ---
        const medicationsContainer = document.getElementById('medicationsContainer');
        let medicationCounter = 0;

        function addMedicationEntry(medication = {}) {
            medicationCounter++;
            const entryDiv = document.createElement('div');
            entryDiv.className = 'medication-entry';
            entryDiv.dataset.id = medicationCounter;
            entryDiv.innerHTML = `
                <div>
                    <label for="medName-${medicationCounter}">שם תרופה:</label>
                    <select id="medName-${medicationCounter}" required>
                        <option value="">בחר תרופה</option>
                        <option value="לוריוון">לוריוון</option>
                        <option value="נורופן">נורופן</option>
                        <option value="אופטלגין">אופטלגין</option>
                        <option value="ויטמין D">ויטמין D</option>
                        <option value="B12">B12</option>
                        <option value="פרוביוטיקה">פרוביוטיקה</option>
                        <option value="אחר">אחר (ציין בהערות)</option>
                    </select>
                </div>
                <div>
                    <label for="medDosage-${medicationCounter}">מינון:</label>
                    <input type="text" id="medDosage-${medicationCounter}" placeholder="לדוגמה: 25 מ&quot;ג, 2 כדורים" value="${medication.dosage || ''}" required>
                </div>
                <div>
                    <label for="medTime-${medicationCounter}">שעת נטילה (אופציונלי):</label>
                    <input type="time" id="medTime-${medicationCounter}" value="${medication.time || ''}">
                </div>
                <div>
                    <label for="medNotes-${medicationCounter}">הערות (אופציונלי):</label>
                    <textarea id="medNotes-${medicationCounter}" rows="2" placeholder="הערות נוספות">${medication.notes || ''}</textarea>
                </div>
                <button type="button" class="remove-medication-btn">הסר תרופה</button>
            `;
            medicationsContainer.appendChild(entryDiv);

            entryDiv.querySelector('.remove-medication-btn').addEventListener('click', () => {
                entryDiv.remove();
            });
        }

        // Add initial medication entry on page load
        document.addEventListener('DOMContentLoaded', () => {
            addMedicationEntry(); // Add one empty entry
        });

        document.getElementById('addMedicationBtn').addEventListener('click', () => {
            addMedicationEntry();
        });

        document.getElementById('medicationForm').addEventListener('submit', async function(e) {
            e.preventDefault();

            const { date, time } = getCurrentDateTime();
            const medications = [];
            const medicationEntries = medicationsContainer.querySelectorAll('.medication-entry');

            if (medicationEntries.length === 0) {
                displayMessage('medicationMessage', 'אנא הוסף לפחות תרופה אחת.', 'error');
                return;
            }

            let allFieldsFilled = true;
            medicationEntries.forEach(entry => {
                const id = entry.dataset.id;
                const name = document.getElementById(`medName-${id}`).value;
                const dosage = document.getElementById(`medDosage-${id}`).value;
                const medTime = document.getElementById(`medTime-${id}`).value;
                const notes = document.getElementById(`medNotes-${id}`).value;

                if (!name || !dosage) { // Name and dosage are required
                    allFieldsFilled = false;
                }

                medications.push({
                    name: name,
                    dosage: dosage,
                    time: medTime,
                    notes: notes
                });
            });

            if (!allFieldsFilled) {
                displayMessage('medicationMessage', 'אנא מלא את כל השדות הנדרשים (שם תרופה ומינון).', 'error');
                return;
            }

            const data = {
                type: 'medication',
                date: date,
                time: time,
                data: {
                    medications: medications
                }
            };

            try {
                const response = await fetch(SCRIPT_URL, {
                    method: 'POST',
                    mode: 'no-cors',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(data)
                });
                displayMessage('medicationMessage', 'התרופות נרשמו בהצלחה!', 'success');
                // Clear all medication entries and add one new empty one
                medicationsContainer.innerHTML = '';
                addMedicationEntry();
            } catch (error) {
                console.error('Error:', error);
                displayMessage('medicationMessage', 'שגיאה ברישום התרופות. נסה שוב.', 'error');
            }
        });

        // Register Service Worker for PWA
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('/daily-health-tracker/service-worker.js')
                    .then(registration => {
                        console.log('Service Worker registered with scope:', registration.scope);
                    })
                    .catch(err => {
                        console.log('Service Worker registration failed:', err);
                    });
            });
        }
    </script>
</body>
</html>
